<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages/user/Play.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pages/user/Play.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { useEffect, useState } from "react";
import { useLocation, useNavigate } from "react-router";
import { collection, query, where, getDocs } from "firebase/firestore";
import { motion, AnimatePresence } from "framer-motion";
import {
    Flag,
    BookOpen,
    Heart,
    Swords,
    ShieldHalf,
    Brain,
    Footprints,
    Eye,
} from "lucide-react";
import { db } from "../../firebase/firebaseConfig";
import { Loader } from "../../components/ui/Loader";
import "./Play.css";

/**
 * Página Play
 *
 * Gestiona una partida:
 * - Carga el evento inicial (start_forest)
 * - Permite avanzar según las opciones
 * - Aplica requisitos por estadísticas
 * - Finaliza cuando no hay mas opciones
 */
export const Play = () => {
    const navigate = useNavigate();
    const location = useLocation();

    /**
     * Información del personaje con el que se está jugando
     */
    const character = location.state?.character;

    /**
     * Estado del evento actual
     */
    const [currentEvent, setCurrentEvent] = useState(null);

    /**
     * Estado de final de partida
     */
    const [isFinished, setIsFinished] = useState(false);

    /**
     * Estado de carga
     */
    const [loading, setLoading] = useState(true);

    /**
     * Si no hay personaje, redirige
     */
    useEffect(() => {
        if (!character) {
            navigate("/dashboard/characters");
        }
    }, [character, navigate]);

    /**
     * Carga un evento por su ID lógico
     */
    const loadEvent = async (eventId) => {
        const q = query(collection(db, "events"), where("id", "==", eventId));

        const snapshot = await getDocs(q);

        if (snapshot.empty) return null;

        return {
            docId: snapshot.docs[0].id,
            ...snapshot.docs[0].data(),
        };
    };

    /**
     * Carga el evento inicial
     */
    useEffect(() => {
        const init = async () => {
            const firstEvent = await loadEvent("start_forest");
            setCurrentEvent(firstEvent);
            setLoading(false);
        };

        init();
    }, []);

    /**
     * Comprueba si el personaje cumple los requisitos
     */
    const canChooseOption = (option) => {
        if (!option.requirements?.stat) return true;

        const { stat, minValue } = option.requirements;

        return character.stats?.[stat] >= minValue;
    };

    /**
     * Al elegir una opción
     */
    const handleOptionClick = async (option) => {
        if (!option.nextEventId) {
            // Es el último evento
            setCurrentEvent({ ...currentEvent, isLast: true });
            return;
        }

        const nextEvent = await loadEvent(option.nextEventId);

        if (!nextEvent) {
            setCurrentEvent({ ...currentEvent, isLast: true });
        } else {
            setCurrentEvent(nextEvent);
        }
    };

    /**
     * UI de carga
     */
    if (loading) {
        return &lt;Loader />;
    }

    /**
     * Fin de la aventura
     */
    if (isFinished) {
        return (
            &lt;motion.div
                className="play-end"
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0 }}
            >
                &lt;h2>Fin de la aventura&lt;/h2>
                &lt;p>{character.name} ha llegado al final de su camino.&lt;/p>
                &lt;button
                    className="play-back-btn"
                    onClick={() => navigate("/dashboard/characters")}
                >
                    &lt;Flag size={18} style={{ marginRight: 6 }} />
                    Volver
                &lt;/button>
            &lt;/motion.div>
        );
    }

    /**
     * Evento activo
     */
    return (
        &lt;div className="play-container">
            &lt;motion.div
                className="play-character-card"
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.5 }}
            >
                &lt;h3>{character.name}&lt;/h3>
                &lt;div className="play-character-stats">
                    &lt;span>
                        &lt;Heart /> {character.stats.vitality}
                    &lt;/span>
                    &lt;span>
                        &lt;Swords /> {character.stats.attack}
                    &lt;/span>
                    &lt;span>
                        &lt;ShieldHalf /> {character.stats.defense}
                    &lt;/span>
                    &lt;span>
                        &lt;Brain /> {character.stats.intelligence}
                    &lt;/span>
                    &lt;span>
                        &lt;Footprints /> {character.stats.dexterity}
                    &lt;/span>
                    &lt;span>
                        &lt;Eye /> {character.stats.perception}
                    &lt;/span>
                &lt;/div>
            &lt;/motion.div>

            {/* Evento actual */}
            &lt;AnimatePresence mode="wait">
                &lt;motion.div
                    key={currentEvent?.docId}
                    className="play-event-card"
                    initial={{ opacity: 0, y: 50 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -50 }}
                    transition={{ duration: 0.5 }}
                >
                    &lt;h2>
                        &lt;BookOpen size={20} style={{ marginRight: 8 }} />
                        {currentEvent?.title}
                    &lt;/h2>
                    &lt;p>{currentEvent?.text}&lt;/p>

                    {currentEvent?.isLast || !currentEvent?.options?.length ? (
                        &lt;motion.button
                            className="play-back-btn"
                            onClick={() => setIsFinished(true)}
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                        >
                            &lt;Flag size={18} style={{ marginRight: 6 }} />
                            Terminar aventura
                        &lt;/motion.button>
                    ) : (
                        &lt;div className="play-options">
                            {currentEvent.options.map((opt, index) => {
                                const allowed = canChooseOption(opt);
                                return (
                                    &lt;motion.button
                                        key={index}
                                        className={`play-option-btn`}
                                        disabled={!allowed}
                                        onClick={() => handleOptionClick(opt)}
                                        whileHover={{
                                            scale: allowed ? 1.02 : 1,
                                        }}
                                        whileTap={{
                                            scale: allowed ? 0.97 : 1,
                                        }}
                                    >
                                        {opt.text}
                                        {opt.requirements?.stat &amp;&amp; (
                                            &lt;small className="play-option-requirement">
                                                Requiere {opt.requirements.stat}{" "}
                                                ≥ {opt.requirements.minValue}
                                            &lt;/small>
                                        )}
                                    &lt;/motion.button>
                                );
                            })}
                        &lt;/div>
                    )}
                &lt;/motion.div>
            &lt;/AnimatePresence>
        &lt;/div>
    );
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#AdminClasses">AdminClasses</a></li><li><a href="global.html#AdminDashboard">AdminDashboard</a></li><li><a href="global.html#AdminEvents">AdminEvents</a></li><li><a href="global.html#AdminLayout">AdminLayout</a></li><li><a href="global.html#AdminSidebar">AdminSidebar</a></li><li><a href="global.html#AdminUsers">AdminUsers</a></li><li><a href="global.html#AppRoutes">AppRoutes</a></li><li><a href="global.html#AuthContext">AuthContext</a></li><li><a href="global.html#AuthProvider">AuthProvider</a></li><li><a href="global.html#BentoCard">BentoCard</a></li><li><a href="global.html#CTA">CTA</a></li><li><a href="global.html#CharacterCard">CharacterCard</a></li><li><a href="global.html#ClassCard">ClassCard</a></li><li><a href="global.html#CreateCharacterModal">CreateCharacterModal</a></li><li><a href="global.html#CreateClassModal">CreateClassModal</a></li><li><a href="global.html#CreateEventModal">CreateEventModal</a></li><li><a href="global.html#CreateUserModal">CreateUserModal</a></li><li><a href="global.html#DeleteModal">DeleteModal</a></li><li><a href="global.html#Demo">Demo</a></li><li><a href="global.html#EventCard">EventCard</a></li><li><a href="global.html#FeatureCard">FeatureCard</a></li><li><a href="global.html#Features">Features</a></li><li><a href="global.html#Header">Header</a></li><li><a href="global.html#Hero">Hero</a></li><li><a href="global.html#Landing">Landing</a></li><li><a href="global.html#Loader">Loader</a></li><li><a href="global.html#Login">Login</a></li><li><a href="global.html#Play">Play</a></li><li><a href="global.html#ProtectedRoute">ProtectedRoute</a></li><li><a href="global.html#Register">Register</a></li><li><a href="global.html#UserCard">UserCard</a></li><li><a href="global.html#UserCharacters">UserCharacters</a></li><li><a href="global.html#UserDashboard">UserDashboard</a></li><li><a href="global.html#UserLayout">UserLayout</a></li><li><a href="global.html#UserSidebar">UserSidebar</a></li><li><a href="global.html#adminApp">adminApp</a></li><li><a href="global.html#adminAuth">adminAuth</a></li><li><a href="global.html#app">app</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#firebaseConfig">firebaseConfig</a></li><li><a href="global.html#handleLogout">handleLogout</a></li><li><a href="global.html#handleStatChange">handleStatChange</a></li><li><a href="global.html#handleSubmit">handleSubmit</a></li><li><a href="global.html#useAuth">useAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Jan 13 2026 12:01:34 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
